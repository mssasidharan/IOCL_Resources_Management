<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project Management</title>

  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for in-browser JSX (prototype use only) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJS for Excel import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: #f1f5f9; }
    /* small scrollbar for table preview */
    .scroll-slim::-webkit-scrollbar { height:10px; width:8px; }
    .scroll-slim::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius:8px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    /* ---------- Utilities ---------- */
    function downloadFile(content, filename, mime='text/csv'){
      const blob = new Blob([content], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    function toCSV(rows, cols){
      const header = cols.join(',');
      const lines = rows.map(r => cols.map(c => {
        const v = r[c] == null ? '' : String(r[c]);
        return `"${v.replace(/"/g,'""')}"`;
      }).join(','));
      return [header, ...lines].join('\\n');
    }
    function addDays(dateStr, days){
      const d = new Date(dateStr);
      d.setDate(d.getDate()+days);
      return d.toISOString().slice(0,10);
    }

    /* ---------- Small mock resources (replaceable) ---------- */
    function generateResources(n=45){
      return Array.from({length:n}).map((_,i)=>({
        id: `R${i+1}`, name: `Resource ${i+1}`, role: i%6===0 ? 'Trainer' : 'Field',
        capacityDaysPerWeek: 6
      }));
    }

    /* ---------- Greedy allocator ---------- */
    function autoAllocate(resources, tasks, projectStart='2025-12-08'){
      const resState = resources.map(r => ({...r, nextFreeDate: projectStart}));
      const locs = tasks.map(t => ({...t}));

      // sort: prefer trainingType 2 (long) then 3 then 1; longer durations earlier
      locs.sort((a,b)=> (b.trainingType||0) - (a.trainingType||0) || (b.durationDays||0) - (a.durationDays||0));

      for (const loc of locs){
        resState.sort((a,b)=> new Date(a.nextFreeDate) - new Date(b.nextFreeDate));
        const candidate = resState[0];
        if(!candidate) break;
        loc.assignedResourceId = candidate.id;
        loc.plannedStart = candidate.nextFreeDate;
        loc.plannedEnd = addDays(loc.plannedStart, (loc.durationDays||1)-1);
        candidate.nextFreeDate = addDays(loc.plannedEnd, 1);
      }
      return locs;
    }

    /* ---------- SheetJS helpers ---------- */
    function readExcelFile(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = e.target.result;
          const wb = XLSX.read(data, { type: 'binary' });
          const parsed = {};
          for (const s of wb.SheetNames){
            const ws = wb.Sheets[s];
            parsed[s] = XLSX.utils.sheet_to_json(ws, {defval: ''});
          }
          resolve({sheets: wb.SheetNames, parsed});
        };
        reader.onerror = reject;
        reader.readAsBinaryString(file);
      });
    }

    /* ---------- Gantt small preview ---------- */
    function Gantt({rows}){
      const dates = rows.flatMap(r => r.plannedStart ? [new Date(r.plannedStart), new Date(r.plannedEnd)] : []).filter(Boolean);
      if(dates.length===0) return <div className="italic text-sm">No planned dates yet</div>;
      const minDate = new Date(Math.min(...dates.map(d=>d.getTime())));
      const maxDate = new Date(Math.max(...dates.map(d=>d.getTime())));
      const days = Math.ceil((maxDate - minDate)/(1000*60*60*24)) + 1;
      return (
        <div className="overflow-auto border rounded p-2 bg-white">
          <div className="text-xs mb-2">Timeline: {minDate.toISOString().slice(0,10)} → {maxDate.toISOString().slice(0,10)} ({days} days)</div>
          <div className="space-y-1">
            {rows.map(r=>(
              <div key={r.id} className="flex items-center">
                <div className="w-40 text-xs truncate">{r.name} <span className="text-gray-400">({r.assignedResourceId||'unassigned'})</span></div>
                <div className="flex-1 h-6 relative bg-gray-50 rounded">
                  {r.plannedStart && (
                    <div className="absolute h-6 rounded shadow"
                         style={{
                           left: `${((new Date(r.plannedStart)-minDate)/(1000*60*60*24))/days*100}%`,
                           width: `${(r.durationDays/days)*100}%`,
                           background: 'linear-gradient(90deg,#60a5fa,#2563eb)'
                         }}
                         title={`${r.plannedStart} → ${r.plannedEnd} (${r.durationDays}d)`} />
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ---------- Editable Spreadsheet Component (simple Excel-like) ---------- */
    function SpreadsheetEditor({columns, rows, onChange, onClose}){
      // columns: array of column keys; rows: array of objects
      const [localRows, setLocalRows] = useState(rows.map(r=>({...r})));

      useEffect(()=> setLocalRows(rows.map(r=>({...r}))), [rows]);

      function updateCell(rowIdx, col, value){
        const next = localRows.slice();
        next[rowIdx] = {...next[rowIdx], [col]: value};
        setLocalRows(next);
        onChange && onChange(next);
      }
      function addRow(){
        const newRow = {};
        columns.forEach(c => newRow[c] = '');
        setLocalRows(prev => { const n = [...prev, newRow]; onChange && onChange(n); return n; });
      }
      function removeRow(i){
        const next = localRows.slice(); next.splice(i,1);
        setLocalRows(next); onChange && onChange(next);
      }
      function pasteFromClipboard(e){
        // simple paste handler: parse TSV or CSV and append rows
        navigator.clipboard.readText().then(text => {
          if(!text) return;
          const lines = text.trim().split(/\\r?\\n/);
          const parsed = lines.map(line => line.split(/\\t|,/));
          const newRows = parsed.map(arr => {
            const obj = {};
            for(let i=0;i<columns.length;i++) obj[columns[i]] = arr[i] || '';
            return obj;
          });
          setLocalRows(prev => { const n = [...prev, ...newRows]; onChange && onChange(n); return n; });
        });
      }

      return (
        <div className="fixed inset-0 z-50 bg-black/30 flex items-start justify-center p-6">
          <div className="bg-white rounded shadow-lg w-full max-w-6xl max-h-[90vh] overflow-auto">
            <div className="flex items-center justify-between p-4 border-b">
              <div className="font-medium">Spreadsheet Editor</div>
              <div className="flex items-center gap-2">
                <button className="px-3 py-1 text-xs bg-gray-100 rounded" onClick={addRow}>Add row</button>
                <button className="px-3 py-1 text-xs bg-gray-100 rounded" onClick={pasteFromClipboard}>Paste</button>
                <button className="px-3 py-1 text-xs bg-rose-500 text-white rounded" onClick={onClose}>Done</button>
              </div>
            </div>

            <div className="p-4">
              <div className="overflow-auto border rounded">
                <table className="min-w-full text-xs">
                  <thead className="bg-slate-50 sticky top-0">
                    <tr>
                      <th className="p-2">#</th>
                      {columns.map(c=> <th key={c} className="p-2 text-left">{c}</th>)}
                      <th className="p-2">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {localRows.map((r,ri)=>(
                      <tr key={ri} className="border-t">
                        <td className="p-1 text-xs">{ri+1}</td>
                        {columns.map(col=>(
                          <td key={col} className="p-1">
                            <input className="w-full p-1 text-xs border rounded" value={r[col]||''} onChange={e=>updateCell(ri,col,e.target.value)} />
                          </td>
                        ))}
                        <td className="p-1">
                          <button className="text-xs text-rose-600" onClick={()=>removeRow(ri)}>Delete</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="mt-3 text-xs text-slate-500">Tip: paste rows from Excel (copy from Excel, click Paste) or type directly.</div>
            </div>
          </div>
        </div>
      );
    }

    /* ---------- Main Single-file SPA ---------- */
    function App(){
      const [page, setPage] = useState('landing'); // landing, resourceAllocation, scheduling (placeholder), dashboards, expenses, docs
      const [showEditor, setShowEditor] = useState(false);

      // resources & tasks stored in state; resources can be uploaded later
      const [resources, setResources] = useState(() =>
