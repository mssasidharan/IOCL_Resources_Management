<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project Resource Manager</title>

  <!-- Tailwind Play CDN (fast prototype styling) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for in-browser JSX transpile (fine for prototype / GitHub Pages demo) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* small page background */
    body { background: #f8fafc; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- App code (JSX) -->
  <script type="text/babel">
    const { useState, useMemo } = React;

    // ----- Constants & mock data generators -----
    const STATES = [
      'Andhra Pradesh','Assam','Bihar','Chhattisgarh','Gujarat','Haryana','Karnataka',
      'Kerala','Madhya Pradesh','Maharashtra','Odisha','Punjab','Rajasthan','Tamil Nadu',
      'Telangana','Uttar Pradesh','West Bengal','Delhi','Jharkhand','Goa'
    ];

    function generateResources(n = 45) {
      return Array.from({ length: n }).map((_, i) => ({
        id: `R${i+1}`,
        name: `Resource ${i+1}`,
        role: i % 6 === 0 ? 'Trainer' : 'Field',
        capacityDaysPerWeek: 6,
        availableFrom: new Date().toISOString().slice(0,10),
        notes: ''
      }));
    }

    function generateLocations(n = 213) {
      const locs = [];
      for (let i=0;i<n;i++){
        const state = STATES[i % STATES.length];
        const lob = ['Retail','Industrial','Corporate'][i % 3];
        const trainingType = [1,2,3][Math.floor(Math.random()*3)];
        let duration;
        if (trainingType===2) duration = Math.random()<0.12 ? (Math.random()<0.5?1:2) : 6;
        else if (trainingType===3) duration = Math.random()<0.33 ? 1 : 2;
        else duration = 1;

        locs.push({
          id: `L${i+1}`,
          name: `Location ${i+1}`,
          state,
          lob,
          trainingType,
          durationDays: duration,
          plannedStart: null,
          assignedResourceId: null,
          plannedEnd: null
        });
      }
      return locs;
    }

    function formatDate(d) {
      if (!d) return '';
      if (typeof d === 'string') return d;
      return d.toISOString().slice(0,10);
    }

    function addDays(dateStr, days){
      const d = new Date(dateStr);
      d.setDate(d.getDate()+days);
      return formatDate(d);
    }

    // ----- Simple greedy allocator -----
    function allocateResources(resources, locations, projectStart='2025-12-08'){
      // shallow copies
      const resState = resources.map(r => ({...r, nextFreeDate: projectStart, state: r.state || null}));
      const locs = locations.map(l => ({...l}));

      // sort: type2 first, then type3, then type1, and longer durations earlier
      locs.sort((a,b)=> b.trainingType - a.trainingType || b.durationDays - a.durationDays);

      for (const loc of locs){
        // choose resource with earliest nextFreeDate
        resState.sort((a,b)=> new Date(a.nextFreeDate) - new Date(b.nextFreeDate));
        const candidate = resState[0];
        if (!candidate) continue;
        loc.assignedResourceId = candidate.id;
        loc.plannedStart = candidate.nextFreeDate;
        loc.plannedEnd = addDays(loc.plannedStart, loc.durationDays - 1);
        candidate.nextFreeDate = addDays(loc.plannedEnd, 1);
      }

      return {resources: resState, locations: locs};
    }

    function toCSV(rows, columns){
      const header = columns.join(',');
      const lines = rows.map(r => columns.map(c => {
        const v = r[c] == null ? '' : String(r[c]);
        return `"${v.replace(/"/g,'""')}"`;
      }).join(','));
      return [header, ...lines].join('\\n');
    }

    // ----- Small Gantt element -----
    function Gantt({rows}){
      const dates = rows.flatMap(r => r.plannedStart ? [new Date(r.plannedStart), new Date(r.plannedEnd)] : []).filter(Boolean);
      if (dates.length === 0) return (<div className="italic text-sm">No planned dates. Run allocation to generate a timeline.</div>);
      const minDate = new Date(Math.min(...dates.map(d=>d.getTime())));
      const maxDate = new Date(Math.max(...dates.map(d=>d.getTime())));
      const days = Math.ceil((maxDate - minDate)/(1000*60*60*24)) + 1;

      return (
        <div className="overflow-auto border rounded p-2 bg-white">
          <div className="text-xs mb-2">Timeline: {formatDate(minDate)} → {formatDate(maxDate)} ({days} days)</div>
          <div className="space-y-1">
            {rows.map(r => (
              <div key={r.id} className="flex items-center">
                <div className="w-40 text-xs truncate">{r.name} <span className="text-gray-400">({r.assignedResourceId||'unassigned'})</span></div>
                <div className="flex-1 h-6 relative bg-gray-50 rounded">
                  {r.plannedStart && (
                    <div
                      className="absolute h-6 rounded shadow"
                      style={{
                        left: `${((new Date(r.plannedStart)-minDate)/(1000*60*60*24))/days*100}%`,
                        width: `${(r.durationDays/days)*100}%`,
                        background: 'linear-gradient(90deg,#60a5fa,#2563eb)'
                      }}
                      title={`${r.plannedStart} → ${r.plannedEnd} (${r.durationDays}d)`}
                    />
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ----- Main App -----
    function ResourceManagerApp(){
      const [resources] = useState(() => generateResources(45));
      const [locations, setLocations] = useState(() => generateLocations(213));
      const [projectStart, setProjectStart] = useState(() => {
        // default next Monday-ish
        const d = new Date(); d.setDate(d.getDate() + 7);
        return d.toISOString().slice(0,10);
      });
      const [filterState, setFilterState] = useState('All');
      const [filterType, setFilterType] = useState('All');
      const [allocations, setAllocations] = useState(null);

      const stateCounts = useMemo(() => {
        const map = {};
        for (const l of locations){ map[l.state] = (map[l.state]||0)+1; }
        return map;
      }, [locations]);

      function handleAllocate(){
        const {resources:rs, locations:locs} = allocateResources(resources, locations, projectStart);
        setAllocations({resources: rs, locations: locs});
        setLocations(locs);
      }

      function handleExportCSV(){
        const rows = (allocations?.locations || locations).map(l => ({
          id: l.id, name: l.name, state: l.state, lob: l.lob, trainingType: l.trainingType,
          durationDays: l.durationDays, assignedResourceId: l.assignedResourceId || '', plannedStart: l.plannedStart || '', plannedEnd: l.plannedEnd || ''
        }));
        const csv = toCSV(rows, ['id','name','state','lob','trainingType','durationDays','assignedResourceId','plannedStart','plannedEnd']);
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'allocations.csv'; a.click();
        URL.revokeObjectURL(url);
      }

      const visibleLocations = (allocations?.locations || locations).filter(l => {
        if (filterState !== 'All' && l.state !== filterState) return false;
        if (filterType !== 'All' && String(l.trainingType) !== String(filterType)) return false;
        return true;
      });

      const summary = useMemo(() => {
        const totalDays = visibleLocations.reduce((s,l) => s + l.durationDays, 0);
        const avgPerResource = (totalDays / resources.length).toFixed(1);
        return { totalLocations: visibleLocations.length, totalDays, avgPerResource };
      }, [visibleLocations, resources.length]);

      return (
        <div className="p-6 min-h-screen bg-slate-50 text-slate-800">
          <header className="mb-6">
            <h1 className="text-2xl font-semibold">Project Resource Manager</h1>
            <p className="text-sm text-slate-600">Manage {resources.length} resources across {locations.length} locations. Auto-allocate and export plans for GitHub Pages demo.</p>
          </header>

          <main className="grid grid-cols-12 gap-6">
            <aside className="col-span-3 bg-white rounded p-4 shadow-sm">
              <h2 className="font-medium">Controls</h2>

              <div className="mt-3 space-y-3 text-sm">
                <label className="block">
                  Project start
                  <input type="date" value={projectStart} onChange={e=>setProjectStart(e.target.value)} className="mt-1 block w-full p-2 border rounded" />
                </label>

                <label className="block">
                  Filter state
                  <select value={filterState} onChange={e=>setFilterState(e.target.value)} className="mt-1 block w-full p-2 border rounded">
                    <option>All</option>
                    {Object.keys(stateCounts).map(s => (<option key={s}>{s}</option>))}
                  </select>
                </label>

                <label>
                  Filter training type
                  <select value={filterType} onChange={e=>setFilterType(e.target.value)} className="mt-1 block w-full p-2 border rounded">
                    <option value="All">All</option>
                    <option value="1">Type 1</option>
                    <option value="2">Type 2</option>
                    <option value="3">Type 3</option>
                  </select>
                </label>

                <div className="flex gap-2">
                  <button onClick={handleAllocate} className="px-3 py-2 bg-blue-600 text-white rounded">Auto Allocate</button>
                  <button onClick={handleExportCSV} className="px-3 py-2 bg-green-600 text-white rounded">Export CSV</button>
                </div>

                <div className="text-xs text-slate-600 mt-3">
                  Note: This is a prototype. Add travel-time, rest days and skills in a later iteration.
                </div>
              </div>
            </aside>

            <section className="col-span-6">
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div className="bg-white p-3 rounded shadow-sm">
                  <h3 className="font-medium">Locations ({visibleLocations.length})</h3>
                  <div className="text-xs text-slate-600">States represented: {Object.keys(stateCounts).length}</div>
                  <div className="mt-2 max-h-44 overflow-auto text-sm">
                    <table className="w-full text-left text-xs">
                      <thead><tr className="text-slate-500"><th>ID</th><th>Loc</th><th>Type</th><th>D</th></tr></thead>
                      <tbody>
                        {visibleLocations.slice(0,20).map(l=> (
                          <tr key={l.id} className="border-t"><td className="pr-2">{l.id}</td><td className="truncate">{l.name} <span className="text-gray-400">{l.state}</span></td><td>{l.trainingType}</td><td>{l.durationDays}</td></tr>
                        ))}
                      </tbody>
                    </table>
                    {visibleLocations.length>20 && <div className="text-xs text-slate-500 mt-2">Showing first 20 locations. Use export to get full list.</div>}
                  </div>
                </div>

                <div className="bg-white p-3 rounded shadow-sm">
                  <h3 className="font-medium">Resources ({resources.length})</h3>
                  <div className="text-xs text-slate-600">Available trainers & field staff</div>
                  <div className="mt-2 max-h-44 overflow-auto text-sm">
                    <ul>
                      {resources.slice(0,12).map(r=> (<li key={r.id} className="border-t py-1">{r.id} - {r.name} <span className="text-gray-400">{r.role}</span></li>))}
                    </ul>
                    {resources.length>12 && <div className="text-xs text-slate-500 mt-2">Showing first 12 resources.</div>}
                  </div>
                </div>
              </div>

              <div className="bg-white p-3 rounded shadow-sm">
                <h3 className="font-medium">Forecast Summary</h3>
                <div className="mt-3 grid grid-cols-3 gap-3 text-sm">
                  <div className="p-2 bg-slate-50 rounded">Locations:<div className="font-semibold">{summary.totalLocations}</div></div>
                  <div className="p-2 bg-slate-50 rounded">Total training-days:<div className="font-semibold">{summary.totalDays}</div></div>
                  <div className="p-2 bg-slate-50 rounded">Avg days/resource:<div className="font-semibold">{summary.avgPerResource}</div></div>
                </div>

                <div className="mt-4">
                  <Gantt rows={(allocations?.locations||locations).slice(0,60)} />
                </div>
              </div>
            </section>

            <aside className="col-span-3 bg-white p-4 rounded shadow-sm">
              <h3 className="font-medium">State breakdown</h3>
              <div className="mt-2 text-sm max-h-96 overflow-auto">
                {Object.entries(stateCounts).map(([s,c])=> (<div key={s} className="flex justify-between py-1 border-b text-xs"><div>{s}</div><div className="font-semibold">{c}</div></div>))}
              </div>

              <div className="mt-4">
                <h4 className="font-medium text-sm">Quick actions</h4>
                <button className="mt-2 w-full py-2 bg-amber-500 text-white rounded" onClick={()=>{
                  const filtered = locations.filter(l=> l.trainingType===2);
                  const {locations:locs} = allocateResources(resources, filtered, projectStart);
                  const master = locations.map(m=> {
                    const f = locs.find(x=> x.id===m.id);
                    return f? {...m, assignedResourceId: f.assignedResourceId, plannedStart: f.plannedStart, plannedEnd: f.plannedEnd} : m;
                  });
                  setLocations(master);
                  setAllocations({resources, locations: master});
                }}>Allocate Type 2 only</button>

                <button className="mt-2 w-full py-2 bg-red-600 text-white rounded" onClick={()=>{
                  const cleared = locations.map(l=> ({...l, assignedResourceId: null, plannedStart: null, plannedEnd: null}));
                  setLocations(cleared); setAllocations(null);
                }}>Clear assignments</button>
              </div>

              <div className="mt-4 text-xs text-slate-500">
                Note: prototype. For production add travel-time, rest days, skills & constraints.
              </div>
            </aside>
          </main>

          <footer className="mt-6 text-xs text-slate-500">Static prototype for GitHub Pages — replace mock data with real lists if available.</footer>
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ResourceManagerApp />);
  </script>
</body>
</html>
